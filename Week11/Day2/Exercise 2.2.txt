WITH REVENUE AS
	(SELECT G.GENRE_NAME AS GENRE,
			M.TITLE,
			M.VOTE_AVERAGE AS POPULARITY,
	 		DENSE_RANK() OVER (PARTITION BY G.GENRE_NAME ORDER BY M.VOTE_AVERAGE DESC) AS RANK_POPULARITY,
			M.REVENUE,
			ROUND(AVG(M.REVENUE) OVER (PARTITION BY G.GENRE_ID), 2) AS GENRE_AVG_REVENUE
		FROM MOVIES.MOVIE AS M
		JOIN MOVIES.MOVIE_GENRES AS MG ON M.MOVIE_ID = MG.MOVIE_ID
		JOIN MOVIES.GENRE AS G ON MG.GENRE_ID = G.GENRE_ID
		WHERE M.REVENUE > 0)
SELECT GENRE,
	TITLE,
	POPULARITY,
	REVENUE,
	RANK_POPULARITY,
	GENRE_AVG_REVENUE
FROM REVENUE
WHERE GENRE_AVG_REVENUE >
		(SELECT AVG(M.REVENUE) FROM MOVIES.MOVIE AS M)